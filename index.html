<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Daily Production Tracker</title>

<style>
/* Base Setup */
body { 
    font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; 
    background: #f4f4f4; 
    margin: 0; 
    padding: 20px; 
    display: flex;
    justify-content: center; 
}

#dailyProdSection { 
    width: 100%; 
    max-width: 900px; 
    background: #fff;
    padding: 20px;
    border-radius: 15px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.1);
}

h1 { margin: 15px 0; font-size: 38px; text-align: center; font-weight: 900; }

.btn { 
    display: block; 
    width: 100%; 
    margin: 10px auto; 
    padding: 22px; 
    background: #007bff; 
    color: white; 
    border-radius: 12px; 
    font-size: 26px; 
    font-weight: bold; 
    cursor: pointer; 
    border: none; 
}

.filter-bar {
    display: flex;
    gap: 12px;
    margin-bottom: 20px;
}

#dailyProdSearch { 
    flex: 2; 
    padding: 18px; 
    font-size: 22px; 
    border-radius: 10px; 
    border: 2px solid #ddd; 
}

.qc-filter-btn {
    flex: 1;
    padding: 15px;
    font-size: 18px;
    font-weight: 900;
    border-radius: 10px;
    border: 3px solid #222;
    background: #fff;
    cursor: pointer;
}
.qc-filter-btn.active { background: #dc3545; color: white; border-color: #a71d2a; }

#dailyProdTableContainer { 
    width: 100%; 
    max-height: 65vh; 
    overflow-y: auto; 
    background: #ffffff; 
    border: 3px solid #222; 
    border-radius: 12px; 
}

.dp-row, .dp-header {
    display: grid;
    grid-template-columns: 0.5fr 1.0fr 4.5fr 3.5fr; 
    align-items: center;
    gap: 10px;
    padding: 15px 10px;
    border-bottom: 2px solid #ddd;
    box-sizing: border-box;
}

.dp-header { 
    background: #222; 
    color: white; 
    font-weight: 900; 
    font-size: 22px; 
    position: sticky; 
    top: 0; 
    z-index: 10; 
}
.dp-header div:last-child { text-align: center; }

.dp-row { 
    font-size: 36px; 
    font-weight: 800; 
    color: #000; 
    line-height: 1.0; 
}

.qc-check { font-size: 40px; cursor: pointer; margin-right: 15px; }
.qc-active { color: #28a745; }
.qc-inactive { color: #ccc; }
.qc-check.disabled { opacity: 0.1; cursor: not-allowed; }

.dp-qty-container { display: flex; justify-content: flex-end; align-items: center; gap: 12px; }

.dp-btn-spin { 
    width: 70px; 
    height: 70px; 
    font-size: 45px; 
    font-weight: 900; 
    border-radius: 12px; 
    border: 3px solid #333; 
    display: flex; 
    align-items: center; 
    justify-content: center; 
}
.btn-plus { color: #2e7d32; border-color: #2e7d32; background: #f1f8e9; }
.btn-minus { color: #c62828; border-color: #c62828; background: #ffebee; }

.dp-qty-display { 
    min-width: 80px; 
    font-size: 44px; 
    font-weight: 900; 
    text-align: center; 
    background: #eee; 
    border-radius: 8px; 
    padding: 5px; 
}
.dp-qty-active { background: #fff8b2 !important; border: 3px solid #ffd700; }
.qty-qc-passed { background-color: #28a745 !important; color: white !important; }

.add-entry-box {
    margin-top: 25px; 
    background: #f9f9f9; 
    padding: 20px; 
    border-radius: 12px; 
    border: 2px solid #ccc;
}
.add-entry-box input {
    width: 100%; 
    padding: 15px; 
    margin-bottom: 12px; 
    font-size: 20px; 
    border-radius: 8px; 
    border: 1px solid #bbb;
    box-sizing: border-box;
}

/* Voice Button style */
.voice-btn {
    width: 70px;
    height: 55px;
    font-size: 30px;
    background: #6c757d;
    color: white;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
}

@media (max-width: 600px) {
    body { padding: 5px; }
    .dp-row, .dp-header { font-size: 22px; grid-template-columns: 0.5fr 1.0fr 4.0fr 4.0fr; }
    .dp-btn-spin { width: 60px; height: 60px; font-size: 32px; }
    .dp-qty-display { font-size: 32px; min-width: 60px; }
}
</style>
</head>

<body onload="loadDailyProdData()">

<div id="dailyProdSection">
    <div style="display: flex; justify-content: space-between; align-items: center; padding-bottom: 15px;">
        <h1 style="margin: 0;">Daily Prod</h1>
        <div style="background: #1a1a1a; color: #00ff41; padding: 10px 20px; border-radius: 10px; text-align: center; border: 2px solid #333;">
            <div style="font-size: 12px; color: #aaa; font-weight: 800;">TOTAL</div>
            <div id="grandTotalDisplay" style="font-size: 38px; font-weight: 900;">0</div>
        </div>
    </div>

    <div class="filter-bar">
        <input id="dailyProdSearch" type="text" placeholder="Search..." oninput="triggerFilter()" />
        <button id="pendingQCBtn" class="qc-filter-btn" onclick="togglePendingFilter()">Pending QC</button>
    </div>

    <div id="dailyProdTableContainer"></div>

    <div class="add-entry-box">
        <h3 style="margin-top:0;">Add Entry</h3>
        <input id="dpNewLocation" type="text" placeholder="Location">
        
        <div style="display: flex; gap: 8px; margin-bottom: 12px;">
            <input id="dpNewProduct" type="text" placeholder="Product Name" style="flex: 1; margin-bottom: 0;">
            <button onclick="startVoiceRecognition(event)" class="voice-btn">üé§</button>
        </div>

        <input id="dpNewQty" type="number" placeholder="Qty">
        <button class="btn" style="background:#28a745; margin:0;" onclick="addNewRow()">+ Add to Sheet</button>
    </div>

    <button class="btn" style="background:#17a2b8; margin-top:20px;" onclick="copyToExcel()">Copy to Excel</button>
</div>

<script>
const dailyProdSheetURL = "https://docs.google.com/spreadsheets/d/1EgAGWL_NL0Hqi4r0S3LPGKRYsYRkpab_sXTjxRHJKhg/gviz/tq?sheet=DailyProd&tq=select%20*";
const scriptURL = "https://script.google.com/macros/s/AKfycbzdMmVgH-d21z8JNbLXEDDJS8HfgHcGoB09vSjhvPX1dTViHVpwmBOa0kxsuEWAKe6mWA/exec";

let dailyProdData = [];
let showOnlyPending = false;

function loadDailyProdData() {
    fetch(dailyProdSheetURL).then(res => res.text()).then(text => {
        const json = JSON.parse(text.substring(text.indexOf("{"), text.lastIndexOf("}") + 1));
        dailyProdData = json.table.rows.map(r => ({
            location: r.c[1]?.v || "", 
            product: r.c[2]?.v || "",
            qty: Number(r.c[3]?.v || 0), 
            qcChecked: r.c[4]?.v === "TRUE" || r.c[4]?.v === true
        })).filter(i => i.location || i.product);
        renderDailyProdTable();
    });
}

// Voice Recognition Logic
function startVoiceRecognition(event) {
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    if (!SpeechRecognition) return alert("Voice not supported on this browser.");
    
    const recognition = new SpeechRecognition();
    const btn = event.currentTarget;
    const input = document.getElementById("dpNewProduct");
    
    btn.innerHTML = "üîä";
    btn.style.background = "#ff4d4d";

    recognition.onresult = (e) => {
        let transcript = e.results[0][0].transcript.toLowerCase();

        // 1. Remove trailing periods
        if (transcript.endsWith('.')) { transcript = transcript.slice(0, -1); }

        // 2. PHONETIC FIXES (Before removing spaces)
        transcript = transcript.replace(/pretty too|pretty to|pt2|pt 2|v t|vee tee/g, "VT");
        
        // Fix for EI sounds (If browser hears "I twenty" instead of "EI twenty")
        transcript = transcript.replace(/i 20|i20/g, "EI20");
        transcript = transcript.replace(/i 30|i30/g, "EI30");
        transcript = transcript.replace(/i 60|i60/g, "EI60");

        // Common number sounds
        transcript = transcript.replace(/zero/g, "0");
        transcript = transcript.replace(/one/g, "1");
        transcript = transcript.replace(/too|to|two/g, "2");
        transcript = transcript.replace(/three/g, "3");
        transcript = transcript.replace(/four|for/g, "4");

        // 3. TRANSLATION RULES
        transcript = transcript.replace(/dash|hyphen|minus/g, "-");
        transcript = transcript.replace(/ayai|ai|eye|a i/g, "EI");
        transcript = transcript.replace(/ayel|il|i l|ail/g, "IL");
        
        // 4. Clean up spaces and convert to UPPERCASE
        transcript = transcript.replace(/\s+/g, '').toUpperCase();

        // 5. Append to existing value
        input.value = input.value + transcript;
        
        btn.innerHTML = "üé§";
        btn.style.background = "#6c757d";
    };

    recognition.onend = () => {
        btn.innerHTML = "üé§";
        btn.style.background = "#6c757d";
    };

    recognition.start();
}

function togglePendingFilter() {
    showOnlyPending = !showOnlyPending;
    document.getElementById("pendingQCBtn").classList.toggle("active", showOnlyPending);
    triggerFilter();
}

function triggerFilter() {
    renderDailyProdTable(document.getElementById("dailyProdSearch").value);
}

function renderDailyProdTable(filter = "") {
    const container = document.getElementById("dailyProdTableContainer");
    container.innerHTML = `<div class="dp-header"><div>#</div><div>Loc</div><div>Product (QC)</div><div>Qty</div></div>`;

    dailyProdData.forEach((item, originalIndex) => {
        if (filter && !item.product.toLowerCase().includes(filter.toLowerCase())) return;
        
        // Logical rule: if "Pending QC" is on, hide approved items or zero-qty items
        if (showOnlyPending && (item.qcChecked || item.qty === 0)) return;

        const isQtyActive = (item.qty > 0);
        const qtyQCClass = (item.qcChecked && isQtyActive) ? "qty-qc-passed" : (isQtyActive ? "dp-qty-active" : "");

        const row = document.createElement("div");
        row.className = "dp-row";
        row.innerHTML = `
            <div style="font-size: 0.5em; color: #888;">${originalIndex + 1}</div>
            <div style="font-size: 0.6em; color: #444;">${item.location}</div>
            <div style="display: flex; align-items: center;">
                <span class="qc-check ${item.qcChecked ? 'qc-active' : 'qc-inactive'} ${isQtyActive ? '' : 'disabled'}" 
                      onclick="toggleQC(${originalIndex})">
                    ${item.qcChecked ? '‚úÖ' : '‚úîÔ∏è'}
                </span>
                <span style="font-size: 0.85em;">${item.product}</span>
            </div>
            <div class="dp-qty-container">
                <button class="dp-btn-spin btn-plus" onclick="changeQty(${originalIndex}, 1)">+</button>
                <span id="qty_${originalIndex}" class="dp-qty-display ${qtyQCClass}">${item.qty}</span>
                <button class="dp-btn-spin btn-minus" onclick="changeQty(${originalIndex}, -1)">‚àí</button>
            </div>`;
        container.appendChild(row);
    });
    updateGrandTotal();
}

function changeQty(index, delta) {
    const item = dailyProdData[index];
    item.qty = Math.max(0, item.qty + delta);
    if (item.qty === 0) item.qcChecked = false;
    saveQtyToSheet(item.location, item.product, item.qty, index + 1, "update", item.qcChecked);
    triggerFilter();
}

function toggleQC(index) {
    const item = dailyProdData[index];
    if (item.qty <= 0) return;
    item.qcChecked = !item.qcChecked;
    saveQtyToSheet(item.location, item.product, item.qty, index + 1, "update", item.qcChecked);
    triggerFilter();
}

function saveQtyToSheet(loc, prod, qty, sheetRowIndex, task, qcStatus) {
    fetch(scriptURL, { method: "POST", mode: "no-cors", body: JSON.stringify({ task, index: sheetRowIndex, location: loc, product: prod, qty, qcChecked: qcStatus }) });
}

function addNewRow() {
    const loc = document.getElementById("dpNewLocation").value.trim();
    const prod = document.getElementById("dpNewProduct").value.trim();
    const qty = Number(document.getElementById("dpNewQty").value || 0);
    if (!loc || !prod) return alert("Enter Loc and Product");
    dailyProdData.push({ location: loc, product: prod, qty, qcChecked: false });
    saveQtyToSheet(loc, prod, qty, dailyProdData.length, "append", false);
    document.getElementById("dpNewLocation").value = "";
    document.getElementById("dpNewProduct").value = "";
    document.getElementById("dpNewQty").value = "";
    triggerFilter();
}

function copyToExcel() {
    let lines = ["Location\tProduct\tQty\tQC"];
    dailyProdData.forEach(r => lines.push(`${r.location}\t${r.product}\t${r.qty}\t${r.qcChecked ? "YES" : "NO"}`));
    navigator.clipboard.writeText(lines.join("\n")).then(() => alert("Copied."));
}

function updateGrandTotal() {
    const total = dailyProdData.reduce((sum, item) => sum + (parseInt(item.qty) || 0), 0);
    document.getElementById("grandTotalDisplay").innerText = total.toLocaleString();
}
</script>
</body>
</html>

